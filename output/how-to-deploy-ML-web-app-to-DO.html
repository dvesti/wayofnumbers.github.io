<!DOCTYPE html>
<html lang="en">
<head>
          <title>Way of Numbers - How to Deploy Your Machine Learning Web App to Digital&nbsp;Ocean</title>
        <meta charset="utf-8" />




    <meta name="tags" content="Machine Learning" />
    <meta name="tags" content="AI" />
    <meta name="tags" content="Deep Learning" />
    <meta name="tags" content="fast.ai" />
    <meta name="tags" content="DigitalOcean" />
    <meta name="tags" content="Docker" />
    <meta name="tags" content="Starlette" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://wayofnumbers.github.io/">Way of Numbers <strong>Data science for the rest of us.</strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/">Homepage</a></li>
            <li><a href="/categories.html">Categories</a></li>
            <li><a href="./pages/about.html">About</a></li>
            <li class="active"><a href="https://wayofnumbers.github.io/category/machine-learning.html">Machine Learning</a></li>
            <li><a href="https://wayofnumbers.github.io/category/tools.html">Tools</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="https://wayofnumbers.github.io/how-to-deploy-ML-web-app-to-DO.html" rel="bookmark"
         title="Permalink to How to Deploy Your Machine Learning Web App to Digital Ocean">How to Deploy Your Machine Learning Web App to Digital&nbsp;Ocean</a></h2>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2019-09-21T20:00:00-05:00">
      Sat 21 September 2019
    </time>
    <address class="vcard author">
      By           <a class="url fn" href="https://wayofnumbers.github.io/author/michael-li.html">Michael Li</a>
    </address>
    <div class="category">
        Category: <a href="https://wayofnumbers.github.io/category/machine-learning.html">Machine Learning</a>
    </div>
    <div class="tags">
        Tags:
            <a href="https://wayofnumbers.github.io/tag/machine-learning.html">Machine Learning</a>
            <a href="https://wayofnumbers.github.io/tag/ai.html">AI</a>
            <a href="https://wayofnumbers.github.io/tag/deep-learning.html">Deep Learning</a>
            <a href="https://wayofnumbers.github.io/tag/fastai.html">fast.ai</a>
            <a href="https://wayofnumbers.github.io/tag/digitalocean.html">DigitalOcean</a>
            <a href="https://wayofnumbers.github.io/tag/docker.html">Docker</a>
            <a href="https://wayofnumbers.github.io/tag/starlette.html">Starlette</a>
    </div>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <div class="toc">
<ul>
<li><a href="#how-to-trainand-export-your-dragonmodel">How to Train(and export) Your&nbsp;Dragon(Model)</a></li>
<li><a href="#github-driven-web-development">‘GitHub-Driven’ Web&nbsp;Development</a></li>
<li><a href="#lets-dockerize-it">Let’s Dockerize&nbsp;it!</a></li>
<li><a href="#next-step-cloud">Next Step,&nbsp;Cloud!</a></li>
<li><a href="#deploy-deploy-deploy">Deploy! Deploy!&nbsp;Deploy！</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</div>
<p>Using Fast.ai, Docker, GitHub, and Starlette <span class="caps">ASGI</span>&nbsp;Framework</p>
<p><img alt="" src="https://cdn-images-1.medium.com/max/5000/1*CIO_AZnYf8OkitOLyjXHHw.png"></p>
<p>You’ve collected your data, cleaned it up diligently, squeezed it into your carefully fine-tuned model and sweated many <span class="caps">GPU</span> hours and trained the model. The prediction is State-Of-The-Art!&nbsp;Bravo!</p>
<blockquote>
<p>But what&nbsp;now?</p>
</blockquote>
<p>Share it with the world of course! It has such great potential and no one has done this before, you want everyone to try it out! How? You&nbsp;ask.</p>
<p>In this tutorial, I’ll introduce you to an affordable and flexible way of deploying your trained Machine Learning model. I’ll walk you through every step in the way and hopefully, after reading this article, you’ll have no issue deploying your ‘next big thing(model)’ to the&nbsp;world.</p>
<h2 id="how-to-trainand-export-your-dragonmodel">How to Train(and export) Your Dragon(Model)<a class="headerlink" href="#how-to-trainand-export-your-dragonmodel" title="Permanent link">&para;</a></h2>
<p><img alt="Image from https://www.facebook.com/HowToTrainYourDragon/" src="https://cdn-images-1.medium.com/max/2000/0*Xd6meR5pp9AfdpXu"><em>Image from <a href="https://www.facebook.com/HowToTrainYourDragon/">https://www.facebook.com/HowToTrainYourDragon/</a></em></p>
<p>First of all, you need to train your model and export it. In this article, we’ll use Fast.ai’s library to showcase how it’s done. You may want to refer to my <a href="https://medium.com/datadriveninvestor/deep-learning-models-by-fast-ai-library-c1cccc13e2b3">two-part articles</a> about how to collect data and train a <strong>Chinese Calligraphy Classifier</strong> model or you can also use your own model. For the purpose of this article, I’ll assume that you already trained the model and achieved your desired accuracy&nbsp;rate.</p>
<p>Fast.ai uses a learn object to train the model, to export your model, use methodlearn.export() to export and save your trained model to a export.pkl file(<em>my model export file from the <a href="https://medium.com/datadriveninvestor/deep-learning-models-by-fast-ai-library-c1cccc13e2b3">link</a> above is around <span class="caps">100MB</span></em>). Save this file, we’ll use that&nbsp;later.</p>
<h2 id="github-driven-web-development">‘GitHub-Driven’ Web Development<a class="headerlink" href="#github-driven-web-development" title="Permanent link">&para;</a></h2>
<p>With the model ready, the next step is web app development. I assume you are a full-stack web developer, so let’s jump right into coding. No, I’m just kidding here. We’ll use a boilerplate web app template on GitHub to quickly get your web app ready. You only need to do some minor tweaks and you’ll be ready to go. If you don’t know what <a href="https://github.com">GitHub</a> is, it is a place to hold the source code of a lot of open-source applications. I already put a ready-made web app’s code there so you can easily download and&nbsp;reuse.</p>
<p>Go to this<a href="https://github.com/wayofnumbers/fastai-vision-uvicorn-gunicorn-starlette-docker"> GitHub repository</a>, click the big green button ‘<strong>Clone or download</strong>’ on the right side, like&nbsp;below:</p>
<p><img alt="" src="https://cdn-images-1.medium.com/max/3534/1*jys25uR-Djp3uWpXCJEcOw.png"></p>
<p>On the pop-down window, copy the link, then go to your terminal and&nbsp;type:</p>
<div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="p">[</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">wayofnumbers</span><span class="o">/</span><span class="n">fastai</span><span class="o">-</span><span class="n">vision</span><span class="o">-</span><span class="n">uvicorn</span><span class="o">-</span><span class="n">gunicorn</span><span class="o">-</span><span class="n">starlette</span><span class="o">-</span><span class="n">docker</span><span class="p">.</span><span class="n">git</span><span class="p">](</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">wayofnumbers</span><span class="o">/</span><span class="n">fastai</span><span class="o">-</span><span class="n">vision</span><span class="o">-</span><span class="n">uvicorn</span><span class="o">-</span><span class="n">gunicorn</span><span class="o">-</span><span class="n">starlette</span><span class="o">-</span><span class="n">docker</span><span class="p">.</span><span class="n">git</span><span class="p">)</span>
<span class="n">cd</span> <span class="n">fastai</span><span class="o">-</span><span class="n">vision</span><span class="o">-</span><span class="n">uvicorn</span><span class="o">-</span><span class="n">gunicorn</span><span class="o">-</span><span class="n">starlette</span><span class="o">-</span><span class="n">docker</span>
</pre></div>


<p>These commands will clone all the required code onto your local machine, under a folder named fastai-vision-uvicorn-gunicorn-starlette-docker and enter that folder. This is the main folder we’ll be working on, there are a couple of things in it that worth&nbsp;explaining:</p>
<p><strong>app</strong>: The structure of this appfolder is as&nbsp;below:</p>
<div class="highlight"><pre><span></span><span class="k">template</span>
<span class="o">|</span><span class="c1">--app.html</span>
<span class="n">main</span><span class="p">.</span><span class="n">py</span>
<span class="n">export</span><span class="p">.</span><span class="n">pkl</span>
</pre></div>


<p>This is where your Starlette web app source code resides. It has a very simple Python file main.py. The <a href="https://www.starlette.io/">**Starlette </a>**is a lightweight <a href="https://asgi.readthedocs.io/en/latest/"><span class="caps">ASGI</span></a> framework/toolkit, which is ideal for building high-performance asyncio&nbsp;services.</p>
<p>It also has the saved model fileexport.pkl. The template folder holds an <span class="caps">HTML</span> template file app.html which will serve as your web app <span class="caps">UI</span>.</p>
<p>Remember the exported export.pkl file you saved? Pull that out and replace the one in this app folder. So the app will use your model. You are also welcomed to update the app.html file for better-looking <span class="caps">UI</span>, but it’s not necessary as far as deployment is concerned. Now the source code of your web app is ready, we need to wrap it into a <a href="https://www.docker.com/">Docker </a>container and do some testing. We use the <strong>Dockerfile</strong> as the config file. We’ll explore more in the next&nbsp;section.</p>
<h2 id="lets-dockerize-it">Let’s Dockerize it!<a class="headerlink" href="#lets-dockerize-it" title="Permanent link">&para;</a></h2>
<p>We will use Docker to create a container where our web app runs. If you don’t know what <a href="https://www.docker.com/">Docker</a> is, just know that it is kind of a mini virtual machine, with all the necessary libraries and dependencies installed so the app can run smoothly. It is smaller and more flexible than real Virtual Machine and can be created and deployed very&nbsp;easily.</p>
<p>First, you need to install Docker. <a href="https://docs.docker.com/install/">Here </a>is a very thorough guide for your reference. After installation, if you are running Ubuntu, then it’s beneficial to run the following&nbsp;commands:</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">groupadd</span> <span class="n">docker</span>
<span class="n">sudo</span> <span class="n">usermod</span> <span class="o">-</span><span class="n">aG</span> <span class="n">docker</span> <span class="err">$</span><span class="k">USER</span>
</pre></div>


<p>This will eliminate the need to use sudoevery time you enter a docker command. Reboot, now docker should be properly&nbsp;installed.</p>
<p>In the same directory where app folder and Dockerfile resides, we need to create a docker image that contains all source code within this folder so we can test things out. Enter the following command(don’t forget the ‘.’ at the&nbsp;end):</p>
<div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">test_app</span> <span class="p">.</span>
</pre></div>


<p>This will start a docker image building process according to the Dockerfile. It will take a while, so let’s take a brief look at what’s inside the&nbsp;Dockerfile:</p>
<div class="highlight"><pre><span></span><span class="o">#</span><span class="mi">1</span> <span class="k">FROM</span> <span class="n">tiangolo</span><span class="o">/</span><span class="n">uvicorn</span><span class="o">-</span><span class="n">gunicorn</span><span class="o">-</span><span class="n">starlette</span><span class="p">:</span><span class="n">python3</span><span class="p">.</span><span class="mi">7</span>
<span class="o">#</span><span class="mi">2</span> <span class="n">RUN</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">fastai</span> <span class="n">aiohttp</span> 
<span class="o">#</span><span class="mi">3</span> <span class="n">RUN</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">jinja2</span> 
<span class="o">#</span><span class="mi">4</span> <span class="n">RUN</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">starlette</span> 
<span class="o">#</span><span class="mi">5</span> <span class="k">COPY</span> <span class="p">.</span><span class="o">/</span><span class="n">app</span> <span class="o">/</span><span class="n">app</span> 
<span class="o">#</span><span class="mi">6</span> <span class="n">WORKDIR</span> <span class="o">/</span><span class="n">app</span> 
<span class="o">#</span><span class="mi">7</span> <span class="n">EXPOSE</span> <span class="mi">80</span>
</pre></div>


<p>It is quite&nbsp;self-explanatory:</p>
<p><strong>Line 1:</strong> Specify from which starter image we’ll build our docker image. We use tiangolo/uvicorn-gunicorn-starlette:python3.7 . You can find its GitHub link <a href="https://github.com/tiangolo/uvicorn-gunicorn-starlette-docker">here</a> and Docker Hub link <a href="https://hub.docker.com/r/tiangolo/uvicorn-gunicorn-starlette/">here</a>.</p>
<p><strong>Line 2,3,4:</strong> Install fast.ai library, jinja template framework, Starlette framework, and other&nbsp;utilities.</p>
<p><strong>Line 5: </strong>Copy your app folder into docker image so our app can run within the docker&nbsp;container.</p>
<p><strong>Line 6, 7:</strong> Assign work directory to the app folder and expose port 80 to outside so we can visit the web app through port 80(<span class="caps">HTTP</span>).</p>
<p>Once the docker image is created, run docker images to check. You’ll find something&nbsp;like:</p>
<div class="highlight"><pre><span></span><span class="n">REPOSITORY</span>    <span class="n">TAG</span>    <span class="n">IMAGE</span> <span class="n">ID</span>    <span class="n">CREATED</span>        <span class="k">SIZE</span>
<span class="n">test_app</span>      <span class="n">latest</span> <span class="n">xxxxxxxxx</span>   <span class="mi">1</span> <span class="n">minutes</span> <span class="n">ago</span>  <span class="mi">4</span><span class="p">.</span><span class="mi">05</span><span class="n">GB</span>
</pre></div>


<p>Now we can fire up a docker container from the created image and test your app&nbsp;locally:</p>
<div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">p</span> <span class="mi">80</span><span class="p">:</span><span class="mi">80</span> <span class="err">\</span>
        <span class="o">-</span><span class="n">v</span> <span class="p">.</span><span class="o">/</span><span class="k">absolute</span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="k">to</span><span class="o">/</span><span class="n">export</span><span class="p">.</span><span class="n">pkl</span><span class="p">:</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">export</span><span class="p">.</span><span class="n">pkl</span> <span class="err">\</span>
        <span class="o">-</span><span class="n">e</span> <span class="n">TITLE</span><span class="o">=</span><span class="ss">&quot;Chinese Calligraphy Classifier&quot;</span> <span class="err">\</span>
        <span class="o">-</span><span class="n">e</span> <span class="n">SUBTITLE</span><span class="o">=</span><span class="ss">&quot;Can disambiguate Chinese calligraphy styles like KaiShu, LiShu, XiaoZhuan&quot;</span> 
        <span class="n">test_app</span>
</pre></div>


<p>On the above docker command, we specified the port to be 80. We transferred two environment variables into the container, <span class="caps">TITLE</span> and <span class="caps">SUBTITLE</span>, they will be used to display our web app <span class="caps">UI</span> titles. At the end we specified our docker image name: test_app. Please note that for export.pkl file, you need to use the absolute path, otherwise Docker will not be able to find&nbsp;it.</p>
<p>If you don’t see any error, your docker container should now be up and running. Head over to your browser and type 127.0.0.1 and hit enter, <a href="https://context.reverso.net/translation/english-spanish/voil%C3%A0">voilà</a>! You should see the web app. Give it a ‘Kaishu’, ‘Lishu’ or ‘Xiaozhuan’ calligraphy image and hit ‘<strong>Classify</strong>’, you should see something like&nbsp;this:</p>
<p><img alt="Very rough web app UI" src="https://cdn-images-1.medium.com/max/2000/1*YvDNYLszPZgfC16I5NO2cg.png"><em>Very rough web app <span class="caps">UI</span></em></p>
<p>You can see the app classified this as ‘KaiShu’, which is correct. Now that your app is up and running on the local machine, we are 80% done. What’s left is to deploy it on the cloud. Let’s head to the cloud&nbsp;next!</p>
<h2 id="next-step-cloud">Next Step, Cloud!<a class="headerlink" href="#next-step-cloud" title="Permanent link">&para;</a></h2>
<p>For the cloud hosting service, we’ll use <a href="https://www.digitalocean.com">DigitalOcean</a>. Comparing to the more incumbent players like Amazon <span class="caps">AWS</span>, <span class="caps">GCP</span>, or Azure, it’s more friendly to developers and cheaper. You can follow <a href="https://www.digitalocean.com/docs/droplets/how-to/create/">this well written and concise tutorial</a> to create an account and a ‘Droplet’ of your own. (‘Droplet’ is a virtual machine running by Digital Ocean where you can install your app in, much like an <span class="caps">AWS</span> instance.) If you want, you can use <a href="https://m.do.co/c/bc334d488542">this link</a> to create your account and get $50 credit for free, which will be enough to get you started. Use the following configuration as a&nbsp;reference:</p>
<p><img alt="" src="https://cdn-images-1.medium.com/max/2428/1*lmMuFFvGN6jnxDRr0q2U1g.png"></p>
<p>It is recommended that you create your Droplets with at least <strong>4G</strong> memory since installing PyTorch will require a lot of memory. You can resize it down to 2G&nbsp;later.</p>
<p>You can choose the default ‘Data Center’ and set up your authentication method. Use <span class="caps">SSH</span> key or password, whichever way you feel more comfortable. I personally prefer <span class="caps">SSH</span> key, fewer keypresses and more secure. Once the Droplet is created, <span class="caps">SSH</span> into it and we are ready for the final&nbsp;deployment!</p>
<h2 id="deploy-deploy-deploy">Deploy! Deploy! Deploy！<a class="headerlink" href="#deploy-deploy-deploy" title="Permanent link">&para;</a></h2>
<p>Now you should be able to <span class="caps">SSH</span> into your server as root. It’s recommended to create a normal user with sudo privilege, you can follow <a href="https://www.digitalocean.com/community/tutorials/how-to-create-a-sudo-user-on-ubuntu-quickstart">this tutorial</a>. Once a normal user is created, log out of your root user and <span class="caps">SSH</span> back into the server with your normal user account. The final deployment is very similar to what we’ve already done on our local machine, only this time we do it on the remote droplet server. First, let’s git clone our repo so we have the source&nbsp;code:</p>
<div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="p">[</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">wayofnumbers</span><span class="o">/</span><span class="n">fastai</span><span class="o">-</span><span class="n">vision</span><span class="o">-</span><span class="n">uvicorn</span><span class="o">-</span><span class="n">gunicorn</span><span class="o">-</span><span class="n">starlette</span><span class="o">-</span><span class="n">docker</span><span class="p">.</span><span class="n">git</span><span class="p">](</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">wayofnumbers</span><span class="o">/</span><span class="n">fastai</span><span class="o">-</span><span class="n">vision</span><span class="o">-</span><span class="n">uvicorn</span><span class="o">-</span><span class="n">gunicorn</span><span class="o">-</span><span class="n">starlette</span><span class="o">-</span><span class="n">docker</span><span class="p">.</span><span class="n">git</span><span class="p">)</span>
<span class="n">cd</span> <span class="n">fastai</span><span class="o">-</span><span class="n">vision</span><span class="o">-</span><span class="n">uvicorn</span><span class="o">-</span><span class="n">gunicorn</span><span class="o">-</span><span class="n">starlette</span><span class="o">-</span><span class="n">docker</span>
</pre></div>


<p>Don’t forget to copy your export.pkl file to replace what’s in the app folder. (follow this <a href="https://unix.stackexchange.com/questions/106480/how-to-copy-files-from-one-machine-to-another-using-ssh">link</a> if you don’t know&nbsp;how)</p>
<p>If docker is not installed, install docker. Then build the docker image using below command. Again, if the image building failed due to low memory, resize your memory up, you can resize it down later without much cost&nbsp;increase.</p>
<div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">test_app</span> <span class="p">.</span>
</pre></div>


<p>Once the image is built, fire up the docker&nbsp;container:</p>
<div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">p</span> <span class="mi">80</span><span class="p">:</span><span class="mi">80</span> <span class="err">\</span>
        <span class="o">-</span><span class="n">v</span> <span class="p">.</span><span class="o">/</span><span class="k">absolute</span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="k">to</span><span class="o">/</span><span class="n">export</span><span class="p">.</span><span class="n">pkl</span><span class="p">:</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">export</span><span class="p">.</span><span class="n">pkl</span> <span class="err">\</span>
        <span class="o">-</span><span class="n">e</span> <span class="n">TITLE</span><span class="o">=</span><span class="ss">&quot;Chinese Calligraphy Classifier&quot;</span> <span class="err">\</span>
        <span class="o">-</span><span class="n">e</span> <span class="n">SUBTITLE</span><span class="o">=</span><span class="ss">&quot;Can disambiguate Chinese calligraphy styles like KaiShu, LiShu, XiaoZhuan&quot;</span> 
        <span class="n">test_app</span>
</pre></div>


<p>Once the docker container is up and running, head over to your browser and enter your Droplet’s <span class="caps">IP</span> address, hit Enter. Congratulations! You’ve successfully deployed your Deep Learning model to the&nbsp;Internet!</p>
<h2 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Permanent link">&para;</a></h2>
<p>Not that hard, huh? Deployment using standard DigitalOcean Droplet offers a lot of flexibilities. You can do whatever you want to your Droplets since you have root access. You can run multiple apps on it, and pay very little($5 - $10 tier should be enough). If your app gets some traction and needs more resources, you can easily scale&nbsp;up.</p>
<p>I hope this tutorial somewhat help you deploy your <span class="caps">AI</span> app. If you have any question or want to share your deployment experience, please write a response below. Happy&nbsp;Deploying!</p>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>